<!DOCTYPE html>
<html lang=cn>

<head>
    <meta charset=utf-8>
    <meta http-equiv=X-UA-Compatible content="IE=edge">
    <meta name=referrer content=no-referrer>
    <meta name=viewport content="width=device-width,initial-scale=1">
    <meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,viewport-fit=cover">
    <script src="http://libs.baidu.com/jquery/2.0.0/jquery.min.js"></script>
    <title>demo</title>
    <style>
        #app {
            display: flex;
            width: 100%;
            /* justify-content: space-between; */
        }

        ul li {
            display: flex;
            justify-content: space-between;
        }

        #detail img {
            width: 600px;
            height: 850px;
        }
    </style>
</head>

<body>
    <input type="text" id="input">
    <button onclick="getData()">查询</button>
    <div id=app>
        <div>
            <ul id="home">

            </ul>
        </div>
        <div>

            <ul id="list">

            </ul>
        </div>
        <div>
            <ul id="detail">

            </ul>
        </div>
    </div>
    </div>
</body>
<script>
    //  // 打开一个 web socket  这里端口号和上面监听的需一致
    var ws = new WebSocket('ws://localhost:3000/');

    ws.onopen = function () {
        // Web Socket 已连接上，使用 send() 方法发送数据
        console.log("已连接...");
    };

    ws.onmessage = function (evt) {
        let { data } = evt;
        let item = JSON.parse(data);
        if (item.message) {
            console.log(item.message);
        } else {
            console.log(`当前下载进度：${item.progress}%, 总页数：${item.allPage} , 已下载：${item.downPage} `);
        }

    };

    ws.onclose = function () {
        // 关闭 websocket
        console.log("连接已关闭...");
    };
    const Api = {
        search: '/api/pingccApi/search?key=',
        list: '/api/pingccApi/list?cartoonId=',
        detail: '/api/pingccApi/detail?chapterId=',
        downLoadAWorl: '/api/downLoadAWorl',
        downLoadAll: '/api/downLoadAll',
        // http://localhost/api/pingccApi/search?key=%E7%A7%9F%E5%80%9F
        // http://localhost/api/pingccApi/list?cartoonId=2yirenzhixia
        // http://localhost/api/pingccApi/detail?chapterId=2316518
    }
    let dataArr = [];
    let listArr = [];
    let title = "";
    let ztTit = "";
    const axios = ({ url, method = "GET", params = {} }) => {
        return new Promise((resolve, reject) => {
            $.ajax({
                url: url,
                type: method,
                data: method == 'GET' ? params : JSON.stringify(params),
                contentType: 'application/json;charset=utf-8',
                dataType: "json",
                success: function (result) {
                    // $("#div1").html(result);
                    resolve(result)
                }
            });
        })
    }
    $("#input").val('斗破苍穹');
    getData();
    function getData() {
        let val = $("#input").val();
        // val = '进击的巨人'
        console.log(val);
        axios({
            url: Api.search + val
        }).then(res => {
            $('#home').html('');
            $('#list').html('');
            $('#detail').html('');
            dataArr = res.data.data;
            res.data.data.forEach((item, index) => {
                $('#home').append(`<li>${index + 1}=><a href="javascript:;" onclick="getList('${item.cartoonId}')">${item.title}</a> <a href="javascript:;" onclick="downloadAll('${item.cartoonId}')">downloadAll</a></li>`)
            });
        })
    }

    function getList(id) {
        return new Promise((resolve, reject) => {
            title = dataArr.find(item => item.cartoonId == id).title;
            axios({
                url: Api.list + id
            }).then(res => {
                $('#list').html('');
                $('#detail').html('');
                listArr = res.data.data;
                res.data.data.forEach((item, index) => {
                    $('#list').append(`<li>${index + 1}=><a href="javascript:;" onclick="getDetail(${item.chapterId})">${item.title}</a> <a href="javascript:;" onclick="oneDownload('${item.chapterId}')">download</a></li>`)
                });
                resolve(res.data.data);
            })
        })

    }
    function getDetail(id) {
        axios({
            url: Api.detail + id
        }).then(res => {
            $('#detail').html('');
            res.data.data[0].content.forEach((item, index) => {
                $('#detail').append(`<li>${index + 1}=>${item}  </li>`)
            });
        })
    }

    function oneDownload(id) {
        ztTit = listArr.find(item => item.chapterId == id).title;
        axios({
            url: Api.downLoadAWorl,
            params: {
                id: id,
                title: title,
                zj_tit: ztTit,
            }
        }).then(res => {
            console.log(res);
        })
    }
    function downloadAll(id) {
        getList(id).then(res => {
            //一次性下载30话（不是卷），是没有问题的
            axios({
                url: Api.downLoadAll,
                method: "POST",
                params: {
                    title: title,
                    arr: res.map(item => ({ id: item.chapterId, title: item.title })).slice(0, 5),
                }
            }).then(res => {
                console.log(res);
            })
        })
    }
</script>

</html>